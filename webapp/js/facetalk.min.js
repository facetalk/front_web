function encode64(input){for(var chr1,chr2,chr3,enc1,enc2,enc3,enc4,output="",i=0,l=input.length,key="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";l>i;)chr1=input.charCodeAt(i++),chr2=input.charCodeAt(i++),chr3=input.charCodeAt(i++),enc1=chr1>>2,enc2=(3&chr1)<<4|chr2>>4,enc3=(15&chr2)<<2|chr3>>6,enc4=63&chr3,isNaN(chr2)?enc3=enc4=64:isNaN(chr3)&&(enc4=64),output=output+key.charAt(enc1)+key.charAt(enc2)+key.charAt(enc3)+key.charAt(enc4);return output}"object"!=typeof JSON&&(JSON={}),!function(){"use strict";function f(e){return 10>e?"0"+e:e}function quote(e){return escapable.lastIndex=0,escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var r,n,i,o,a,f=gap,u=t[e];switch(u&&"object"==typeof u&&"function"==typeof u.toJSON&&(u=u.toJSON(e)),"function"==typeof rep&&(u=rep.call(t,e,u)),typeof u){case"string":return quote(u);case"number":return isFinite(u)?String(u):"null";case"boolean":case"null":return String(u);case"object":if(!u)return"null";if(gap+=indent,a=[],"[object Array]"===Object.prototype.toString.apply(u)){for(o=u.length,r=0;o>r;r+=1)a[r]=str(r,u)||"null";return i=0===a.length?"[]":gap?"[\n"+gap+a.join(",\n"+gap)+"\n"+f+"]":"["+a.join(",")+"]",gap=f,i}if(rep&&"object"==typeof rep)for(o=rep.length,r=0;o>r;r+=1)"string"==typeof rep[r]&&(n=rep[r],i=str(n,u),i&&a.push(quote(n)+(gap?": ":":")+i));else for(n in u)Object.prototype.hasOwnProperty.call(u,n)&&(i=str(n,u),i&&a.push(quote(n)+(gap?": ":":")+i));return i=0===a.length?"{}":gap?"{\n"+gap+a.join(",\n"+gap)+"\n"+f+"}":"{"+a.join(",")+"}",gap=f,i}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(e,t,r){var n;if(gap="",indent="","number"==typeof r)for(n=0;r>n;n+=1)indent+=" ";else"string"==typeof r&&(indent=r);if(rep=t,t&&"function"!=typeof t&&("object"!=typeof t||"number"!=typeof t.length))throw new Error("JSON.stringify");return str("",{"":e})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(e,t){var r,n,i=e[t];if(i&&"object"==typeof i)for(r in i)Object.prototype.hasOwnProperty.call(i,r)&&(n=walk(i,r),void 0!==n?i[r]=n:delete i[r]);return reviver.call(e,t,i)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),function(e,t){"function"==typeof define&&define.amd?define(t):"object"==typeof module&&module.exports?module.exports=t():this[e]=t()}("Storage",function(){var i,e=window.JSON&&window.JSON.stringify&&window.JSON.parse?window.JSON:{stringify:function(e){return e},parse:function(e){return e}},t=function(){var t;try{var n,t,r=new ActiveXObject("htmlfile");r.open(),r.write('<iframe src="/favicon.ico"></iframe>'),r.close(),n=r.frames[0].document,t=n.createElement("div"),n.appendChild(t),t.addBehavior("#default#userData")}catch(i){}return{get:function(r){var n;t.load(r),n=t.getAttribute(r);try{n=e.parse(n)}catch(i){}return n},set:function(r,n,i){if(i){var o=new Date;o.setTime(o.getTime()+1e3*i),t.expires=o.toUTCString()}t.setAttribute(r,e.stringify(n)),t.save(r)},remove:function(e){t.removeAttribute(e),t.save(e)}}},r=function(){var t=(new Date).getTime();for(key in localStorage){var r=localStorage.getItem(key);try{r=e.parse(r)}catch(n){}if(Object.prototype.toString.call(r).toLowerCase().indexOf("array")>0){var i=r[0].expires;i&&/^\d{13,}$/.test(i)&&t>=i&&localStorage.removeItem(key)}}return{get:function(t){var r=localStorage.getItem(t);if(!r)return null;try{r=e.parse(r)}catch(n){}if("object"!=typeof r)return r;var i=r[0].expires;if(i&&/^\d{13,}$/.test(i)){var o=(new Date).getTime();if(o>=i)return localStorage.removeItem(t),null;r.shift()}return r[0]},set:function(t,r,n){var i=[];if(n){var o=(new Date).getTime();i.push({expires:o+1e3*n})}i.push(r),localStorage.setItem(t,e.stringify(i))},remove:function(e){localStorage.removeItem(e)}}},n={get:function(t){var n,r=document.cookie,i=r.indexOf(t+"="),o=r.indexOf(";",i);if(-1==o&&(o=r.length),i>-1){n=r.substring(i+t.length+1,o);try{n=e.parse(n)}catch(f){}return n}return null},set:function(t,r,n,i,o){var i=i||"/",f="";if(n)if(window.ActiveXObject){var a=new Date;a.setTime(a.getTime()+1e3*n),f="expires="+a.toGMTString()}else f="max-age="+n;document.cookie=t+"="+e.stringify(r)+";"+f+";path="+i+";"+(o?"domain="+o:"")},remove:function(e,t,r){this.set(e,"",-1,t,r)}};return i=window.localStorage?r():t(),{get:i.get,set:i.set,remove:i.remove,cookie:n}});var app=angular.module("facetalk",["ionic","facetalk.Services","facetalk.Controllers"]),_$=function(id){return document.getElementById(id)};location.hash="/tab/home",app.config(function($httpProvider){$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8"}),app.filter("gifTime",function(){return function(value,para){var arr=/([^\/]+)_(\d+)\.gif/.exec(value);return arr?"jid"==para?arr[1]:arr[2]:value}}).filter("escape",function(){return function(value){return encodeURI(value)}}).filter("unreaded",function(){return function(value,jid){return value[jid]}}),app.config(function($stateProvider,$urlRouterProvider){var random=1;$stateProvider.state("index",{url:"/index",templateUrl:"index.html?"+random}),$stateProvider.state("tabs",{url:"/tab",templateUrl:"template/tabs.html?"+random,resolve:{userinfo:function($ionicUser){var name=Storage.cookie.get("_fh_username");return name?$ionicUser.getInfo(name):void 0}},controller:function($rootScope,$scope,$ionicNavBarDelegate,$ionicXmpp,$ionicTip,$ionicVideo){$scope.select=function(hash){if(!($rootScope.isLogin&&$rootScope.isComplete||$ionicVideo.stream))return $rootScope.isComplete||Storage.cookie.remove("_fh_username"),void $ionicTip.show("请先登录").timeout();if(0!=$ionicXmpp.status)return void $ionicTip.show("请先挂断视频通话再访问本页面").timeout();if($ionicVideo.stream){if(!$rootScope.isComplete)return void $ionicTip.show("请先完成拍照保存再访问本页面").timeout();$ionicVideo.stream.stop()}location.hash=hash},$scope.back=function(){$ionicNavBarDelegate.back()}}}),$stateProvider.state("tabs.home",{url:"/home",views:{"tab-home":{templateUrl:"template/home.html?"+random,controller:function($rootScope,$scope,$http,$ionicLoading,$ionicXmpp,$ionicClient,$ionicNotice){var base=0,offset=24;if($scope.hasMore=!0,$scope.askNotice=function(){$ionicNotice.init()},$scope.loadMore=function(){var url="/api/facesms/getUserListByPage/"+$rootScope.userInfo.username+"/"+base+"/"+offset;$http.get(url).success(function(data){var l=data.length;$scope.users=$scope.users?$scope.users.concat(data):data,l==offset?(base+=offset,$scope.hasMore=!0,$scope.$broadcast("scroll.infiniteScrollComplete")):$scope.hasMore=!1})},!$ionicClient.supportVideo){var msg="";if($ionicClient.isIOS)msg="脸呼暂不兼容您的苹果手机，请在计算机或安卓系统的手机上使用chrome浏览器访问脸呼获得最佳的用户体验";else if($ionicClient.isPC){var link=$ionicClient.isMAC?"http://rj.baidu.com/soft/detail/25718.html":"http://rj.baidu.com/soft/detail/14744.html";msg='您的浏览器暂不兼容脸呼，请使用chrome浏览器访问脸呼获得最佳的用户体验,<a class="link" target="_blank" href="'+link+'">点击下载Chrome浏览器</a>'}else msg="您的浏览器暂不兼容脸呼，请使用chrome浏览器访问脸呼获得最佳的用户体验";$ionicLoading.show({template:msg})}}}}}).state("tabs.login",{url:"/login",views:{"tab-home":{templateUrl:"template/login.html?"+random}}}).state("tabs.regist",{url:"/regist",views:{"tab-home":{templateUrl:"template/regist.html?"+random}}}).state("tabs.takeTip",{url:"/takeTip",views:{"tab-home":{templateUrl:"template/take-tip.html?"+random,controller:function($scope){$scope.takeURL="#/tab/take"}}}}).state("tabs.removeTip",{url:"/removeTip",views:{"tab-home":{templateUrl:"template/remove-tip.html?"+random}}}).state("tabs.take",{url:"/take",views:{"tab-home":{templateUrl:"template/take.html?"+random}}}).state("tabs.detail",{url:"/detail/:jid",views:{"tab-home":{templateUrl:"template/detail.html?"+random}}}).state("tabs.chat",{url:"/chat/:roomid/:nick",views:{"tab-home":{templateUrl:"template/chat.html?"+random}}}),$stateProvider.state("tabs.xin",{url:"/xin",views:{"tab-xin":{templateUrl:"template/xin.html?"+random}}}).state("tabs.xin-detail",{url:"/xin-detail/:jid/:name",views:{"tab-xin":{templateUrl:"template/xin-detail.html?"+random}}}),$stateProvider.state("tabs.history",{url:"/history",views:{"tab-history":{templateUrl:"template/history.html?"+random,controller:function($rootScope,$scope,$http,$ionicTip){var info=$rootScope.userInfo,base=0,offset=10;$ionicTip.hide(),$scope.hasMore=!0,$scope.loadMore=function(){$http.get("/api/pay/getChatRecords/"+info.username+"/"+base+"/"+offset).success(function(data){var l=data.length;if(l){for(var i=0;l>i;i++){var d=data[i],name=d.partnerUserName,type=d.callType,date=d.beginTime;data[i].img="/avatar/"+name+".40.png",data[i].type="called"==type?"呼入":"呼出",data[i].date=date}$scope.items=$scope.items?$scope.items.concat(data):data,l==offset?(base+=offset,$scope.hasMore=!0,$scope.$broadcast("scroll.infiniteScrollComplete")):$scope.hasMore=!1}else $scope.hasMore=!1}).error(function(){})}}}}}).state("tabs.hDetail",{url:"/hDetail/:jid",views:{"tab-history":{templateUrl:"template/detail.html?"+random}}}).state("tabs.hChat",{url:"/hChat/:roomid/:nick",views:{"tab-history":{templateUrl:"template/chat.html?"+random}}}),$stateProvider.state("tabs.setting",{url:"/setting",views:{"tab-setting":{templateUrl:"template/setting.html?"+random,controller:function($rootScope,$scope,$http,$state,$ionicXmpp){var info=$rootScope.userInfo;info.img="/avatar/"+info.username+".100.png?"+(new Date).getTime(),$scope.info=info,$scope.logout=function(){Storage.cookie.remove("_fh_username");try{$ionicXmpp.connection.disconnect()}catch(e){}$ionicXmpp.connection=null,$rootScope.userInfo=null,$rootScope.isLogin=!1,$rootScope.isComplete=!1,$state.go("tabs.home")}}}}}).state("tabs.settingTakeTip",{url:"/settingTakeTip",views:{"tab-setting":{templateUrl:"template/take-tip.html?"+random,controller:function($scope){$scope.takeURL="#/tab/settingTake"}}}}).state("tabs.settingTake",{url:"/settingTake",views:{"tab-setting":{templateUrl:"template/take.html?"+random}}}).state("tabs.about",{url:"/about",views:{"tab-setting":{templateUrl:"template/about.html?"+random}}}),$urlRouterProvider.otherwise("/tab/home")});var servicesModule=angular.module("facetalk.Services",[]);servicesModule.factory("$ionicStorage",function($rootScope){return{version:"0.0.1",max:{notices:10,perCons:20},set:function(message,isMe){this.facexin||this.init();for(var index,notices=this.facexin.notices,xins=this.facexin.xins,jid=message.jid,found=!1,i=0;i<notices.length;i++){var notice=notices[i],n_jid=notice.jid;if(jid==n_jid){found=!0,index=i;break}}isMe||(found&&notices.splice(i,1),notices.unshift(message),notices.length>this.max.notices&&notices.slice(0,this.max.notices));var list,xin=xins[jid];xin||(xins[jid]={unreaded:0,name:message.name,lists:[]}),isMe||(xins[jid].unreaded+=1,$rootScope.$apply(function(){$rootScope.badgeCounts=($rootScope.badgeCounts||0)+1})),list={text:message.text,url:message.url},xins[jid].lists=xins[jid].lists||[],xins[jid].lists.push(list),xins[jid].lists.length>this.max.perCons&&(xins[jid].lists=xins[jid].lists.slice(-this.max.perCons+1)),Storage.set("facexin",this.facexin),isMe||$rootScope.$broadcast("news",message)},init:function(){var my_jid=$rootScope.userInfo.username,version=Storage.get("facexin_version");this.facexin=Storage.get("facexin")||{jid:$rootScope.userInfo.username,notices:[],xins:{}},this.facexin&&this.facexin.jid==my_jid&&version==this.version||(Storage.remove("facexin"),this.facexin={jid:my_jid,notices:[],xins:{}},version!=this.version&&Storage.set("facexin_version",this.version))}}}).factory("$ionicNotice",function($ionicTip,$http){return{init:function(){try{Notification&&("granted"==Notification.permission||"denied"!=Notification.permission&&($ionicTip.show("请点击允许使用桌面通知，方便及时收到好友的视频请求").timeout(),Notification.requestPermission(function(status){Notification.permission!==status&&(Notification.permission=status),"granted"==status?$http.get("/log_gif/desktop_notice.gif?agree"):"denied"==status&&$http.get("/log_gif/desktop_notice.gif?reject")})))}catch(e){}},setNotice:function(jid,nick){var itv,msg1="▣ "+nick+" 想和您视频通话",msg2="◈ "+nick+" 想和您视频通话",i=1;try{Notification&&"granted"==Notification.permission&&new Notification("来电提醒",{icon:"/avatar/"+jid+".100.png",body:nick+" 想和您视频通话"})}catch(e){}document.title=msg1,itv=setInterval(function(){var msg=i%2==0?msg1:msg2;i++,document.title=msg,7==i&&(clearInterval(itv),document.title="脸呼 - 在线视频聊天交友平台",i=0)},1e3)},facexin:function(){_$("xinAd").play()}}}).factory("$ionicRecord",function($interval){return{run:function(options,callback){var video=options.video,w=video.offsetWidth,h=video.offsetHeight;if(video){var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");canvas.width=w,canvas.height=h;var encoder=new GIFEncoder,times=1e3*(options.times||2),snapshoot=options.snapshoot||10,delay=parseInt(times/snapshoot);encoder.setRepeat(0),encoder.setDelay(delay),encoder.start(),$interval(function(){ctx.drawImage(video,0,0,w,h),encoder.addFrame(ctx)},delay,snapshoot).then(function(){encoder.finish();var binary_gif=encoder.stream().getData(),data="data:image/gif;base64,"+encode64(binary_gif);callback&&"function"==typeof callback&&callback(data)})}},showTimer:function(elm,timer){if(!_$("recording")){var div=document.createElement("div");div.id="recording",div.className="recording hidden",div.innerHTML='<div class="bg"></div><div class="cons"><span class="shine"></span> 录制中 ... <span>'+timer+"</span>秒</div>",elm.appendChild(div)}var recording=angular.element(_$("recording")),left=recording.find("span").eq(1),i=timer;recording.removeClass("hidden"),$interval(function(){left.html(--i)},1e3,timer).then(function(){left.html(timer),recording.addClass("hidden")})}}}).factory("$ionicStatus",function(){return{isFree:0,isWaiting:1,isContinue:2,isChatting:3}}).factory("$ionicClient",function($rootScope){var userAgent=navigator.userAgent,supportVideo=$rootScope.supportVideo=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,isIOS=$rootScope.isIOS=/(?:iphone|ipad)/i.test(userAgent),isPC=$rootScope.isPC=!/(?:mobile|android|iphone)/i.test(userAgent),isMAC=$rootScope.isMAC=/macintosh/i.test(userAgent);return{supportVideo:supportVideo,isIOS:isIOS,isPC:isPC,isMAC:isMAC}}).factory("$ionicTip",function($ionicLoading,$timeout){return{show:function(msg,noBg){var bl=!0;return"false"==noBg&&(bl=!1),this.timer&&$timeout.cancel(this.timer),$ionicLoading.show({template:msg,noBackdrop:bl}),this},hide:function(){this.timer&&$timeout.cancel(this.timer),$ionicLoading.hide()},timeout:function(timeout,callback){var timeout=timeout||2e3;this.timer=$timeout(function(){$ionicLoading.hide(),"function"==typeof callback&&callback()},timeout)}}}).factory("$validor",function($ionicTip){return{msgs:{emailRequired:"邮箱地址不能为空",email:"请输入正确的邮箱地址",pwdRequired:"请输入密码",pwd:"密码格式错误:6~16位字符,区分大小写",nameRequired:"昵称不能为空",name:"昵称格式错误:4~18位汉字或英文字符"},login:function(form){var msg,email=form.loginEmail,pwd=form.loginPassword,msgs=this.msgs;if(email.$invalid){var errors=email.$error;errors.required?msg=msgs.emailRequired:errors.email&&(msg=msgs.email)}else pwd.$invalid&&(msg=msgs.pwdRequired);$ionicTip.show(msg).timeout()},regist:function(form){var msg,email=form.email,pwd=form.password,name=form.name,msgs=this.msgs;if(email.$invalid){var errors=email.$error;errors.required?msg=msgs.emailRequired:errors.email&&(msg=msgs.email)}else if(name.$invalid){var errors=name.$error;msg=errors.required?msgs.nameRequired:msgs.name}else if(pwd.$invalid){var errors=pwd.$error;msg=errors.required?msgs.pwdRequired:msgs.pwd}$ionicTip.show(msg).timeout()}}}).factory("$ionicUser",function($rootScope,$http,$ionicTip,$ionicXmpp){return{getInfo:function(name,cb){return $http.get("/api/user/get/"+name).success(function(data){$rootScope.userInfo=data,$rootScope.isLogin=!0,$rootScope.isComplete=1==data.infoCompleteness,1==data.infoCompleteness&&$ionicXmpp.bind.call($ionicXmpp,data.username),"function"==typeof cb&&cb()}).error(function(){})},login:function(email,pwd,cb){var para="loginEmail="+email+"&loginPassword="+pwd,self=this;$http.post("/login",para).success(function(data){var status=data.status;if("success"==status){var username=data.username||Storage.cookie.get("_fh_username");self.getInfo(username,cb)}else $ionicTip.show("邮箱地址或密码错误").timeout()}).error(function(){})},regist:function(name,pwd,email,cb){var para="name="+name+"&password="+pwd+"&email="+email,self=this;$http.post("/api/user/register",para).success(function(data){var status=data.status;return"success"==status?self.login(email,pwd,cb):void $ionicTip.show(data.desc).timeout()}).error(function(){})}}}).factory("$ionicXmpp",function($rootScope,$http,$state,$ionicPopup,$ionicNavBarDelegate,$ionicTip,$ionicNotice,$ionicStorage,$filter){return{server:"/http-bind",status:0,xmpp:null,popup:null,connection:null,bind:function(name){var self=this;$http.get("/api/user/loginForXmpp/"+name).success(function(data){var con=new Strophe.Connection(self.server);self.xmpp=data,self.connection=con,con.attach(data.jid,data.sid,data.rid,function(status){self.connecting.call(self,status)})}).error(function(body,status){403==status&&($rootScope.isLogin=!1,$rootScope.isComplete=!1,Storage.cookie.remove("_fh_username"))})},connecting:function(status){if(status==Strophe.Status.ATTACHED){var self=this,con=self.connection;con.send($pres().c("show").t("chat")),con.addHandler(function(message){return self.message.call(self,message),!0},null,"message","chat")}},setStatus:function(status){var con=this.connection;0==status?con.send($pres().c("show").t("chat")):(1==status||2==status||3==status)&&con.send($pres().c("show").t("dnd")),this.status=status},sendSignal:function(signal,from,to){var con=this.connection,from_jid=from.jid,from_nick=from.nick,to_jid=to.jid,to_nick=to.nick,self=this;con.send($msg({type:"chat",to:to_jid+"@facetalk",nick:from_nick,time:(new Date).getTime()}).c("body").t(signal)),"video"==signal?(self.setStatus(1),$ionicTip.show("正在发送视频请求，请勿刷新页面 ...","false").timeout(3e4,function(){self.sendSignal("timeout",from,to)})):"ok"==signal?(self.setStatus(3),$state.go("tabs.chat",{roomid:to_jid+"_"+from_jid,nick:encodeURI(to_nick)})):"no"==signal?self.setStatus(0):"busy"==signal||"timeout"==signal&&$ionicPopup.confirm({title:"超时通知",template:"对方未响应，请稍后重试 ...",okText:"给TA留言",cancelText:"确定"}).then(function(res){self.setStatus(0),res&&$state.go("tabs.xin-detail",{jid:to_jid,name:encodeURI(to_nick)})})},message:function(message){var from_info=message.getAttribute("from"),f_jid=from_info.split("@")[0],gifId=message.getAttribute("gifid"),signal=message.childNodes[0].innerHTML,nick=message.getAttribute("nick"),self=this;if(gifId){var h1=gifId.substring(0,2),h2=gifId.substring(2,4),news={jid:f_jid,name:nick,url:"/faceSmsGif/"+h1+"/"+h2+"/"+gifId+".gif",text:signal};$ionicStorage.set(news),$ionicNotice.facexin()}else{var from_jid=$rootScope.userInfo.username,from_nick=$rootScope.userInfo.name,from={jid:from_jid,nick:from_nick},to={jid:f_jid,nick:nick};if("video"==signal){if(0!=self.status)return void self.sendSignal("busy",from,to);self.setStatus(2),$ionicPopup.confirm({title:"来电提醒",template:'<div id="videoPOP" class="row request"><div class="col col-33 col-center"><img src="/avatar/'+f_jid+'.png"/></div><div class="col col-67"><strong>'+nick+"</strong> 想和您进行视频聊天</div></div>",okText:"同意",cancelText:"拒绝"}).then(function(res){_$("noticeAd").pause(),_$("noticeAd").currentTime=0,res?self.sendSignal("ok",from,to):self.sendSignal("no",from,to)}),$ionicNotice.setNotice(f_jid,nick),_$("noticeAd").play()}else if("ok"==signal){var roomid=self.xmpp.jid.split("@")[0]+"_"+f_jid;self.setStatus(3),/history/.test(location.hash)?$state.go("tabs.history.chat",{roomid:roomid}):$state.go("tabs.chat",{roomid:roomid,nick:encodeURI(nick)})}else if("no"==signal)$ionicTip.hide(),$ionicPopup.confirm({title:"脸呼消息",template:"对方拒绝了您的请求 ...",okText:"给TA留言",cancelText:"确定"}).then(function(res){self.setStatus(0),res&&$state.go("tabs.xin-detail",{jid:f_jid,name:encodeURI(nick)})});else if("busy"==signal)$ionicTip.hide(),$ionicPopup.confirm({title:"脸呼消息",template:"对方正在通话中，请稍后再试 ...",okText:"给TA留言",cancelText:"确定"}).then(function(res){self.setStatus(0),res&&$state.go("tabs.xin-detail",{jid:f_jid,name:encodeURI(nick)})});else if("timeout"==signal){var time=message.getAttribute("time"),f_time=$filter("date")(time,"HH:mm");_$("noticeAd").pause(),_$("noticeAd").currentTime=0,$ionicPopup.confirm({title:"未接来电",template:'<div class="row request"><div class="col col-33 col-center"><img src="/avatar/'+f_jid+'.png"/></div><div class="col col-67"><strong>'+nick+"</strong> 与 "+f_time+" 呼叫过您</div></div>",okText:"回拨",cancelText:"确定"}).then(function(res){var videoPop=_$("videoPOP");if(videoPop){var pop=angular.element(videoPop).parent().parent();pop[0].previousSibling.className="backdrop",pop.remove()}self.setStatus(0),res&&self.sendSignal("video",from,to)})}else"PermissionDeniedError"==signal&&$ionicTip.show("对方拒绝开启摄像装备，将无法和对方建立连接，请点击左上角结束 ...").timeout(5e3)}}}}).factory("$ionicVideo",function($rootScope,$http,$ionicNavBarDelegate,$ionicLoading,$ionicXmpp,$ionicTip,$timeout){var isEnder;return{stream:null,loadVideo:function(elm,openVideoTip,success,error){var self=this,elm=elm||_$("face");$ionicTip.show(openVideoTip?openVideoTip:$rootScope.isPC?'请看上面的浏览器提示<img src="images/icons/arrow.png"/>，点击“允许”按钮，否则您无法完成注册':"请按照浏览器提示，允许使用摄像头以完成注册"),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia({video:!0,audio:!1},function(stream){var video=elm;$ionicTip.hide(),window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,video.src=window.URL.createObjectURL(stream),self.stream=stream,success&&"function"==typeof success?success():($ionicTip.hide(),$timeout(function(){$ionicTip.show("请确保自拍头像清晰完整。注意，系统会删除不符合要求的头像。").timeout(3e3)},500))},function(err){console.log(err),error&&"function"==typeof error?error(err):$ionicTip.show('浏览器未能开启摄像头，请按此<a class="link" target="_blank" href="http://tieba.baidu.com/p/3234947658">（链接）</a>说明，开启摄像头以完成注册。')})},take:function(){var videoStream=this.stream,video=document.getElementById("face"),take=document.getElementById("take"),choose=document.getElementById("choose");videoStream&&(video.pause(),take.className="hidden",choose.className="row")},choose:function(callback){var video=document.getElementById("face"),w=video.offsetWidth,h=video.offsetHeight,name=$rootScope.userInfo.username,self=this,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");canvas.width=200,canvas.height=260,ctx.drawImage(video,-(w-200)/2,0,w,h);var para="username="+name+"&picData="+encodeURIComponent(canvas.toDataURL());$http.post("/api/user/savePic",para).success(function(data){var status=data.status;"success"==status?(self.stream.stop(),self.stream=null,$rootScope.isComplete=!0,$ionicXmpp.connection||$ionicXmpp.bind.call($ionicXmpp,name),$timeout(function(){$ionicLoading.hide(),callback&&"function"==typeof callback&&callback()},2e3)):$ionicLoading.show({template:data.desc})}).error(function(){}),$ionicLoading.show({template:'<em class="ion-loading-c"></em>&nbsp;&nbsp;正在保存您的头像，即将完成 ...'})},reset:function(){var video=document.getElementById("face"),take=document.getElementById("take"),choose=document.getElementById("choose");choose.className="hidden",take.className="",video.play()},initRTC:function(opts){var vid,roomid=opts.roomid,con=$ionicXmpp.connection,m_jid=$rootScope.userInfo.username,webrtc=$ionicXmpp.webrtc;webrtc?webrtc.startLocalVideo():(webrtc=$ionicXmpp.webrtc=new SimpleWebRTC({url:"https://www.facehu.cn:8888",localVideoEl:"local",remoteVideosEl:"remote",autoRequestMedia:!0}),webrtc.on("readyToCall",function(){webrtc.joinRoom(roomid)}),webrtc.on("videoAdded",function(){$ionicTip.hide(),0==roomid.indexOf(m_jid)&&$http.get("/api/pay/chatRecord/begin/"+roomid.replace("_","/")).success(function(data){vid=data.id}).error(function(){})}),webrtc.on("videoRemoved",function(){isEnder?$ionicXmpp.setStatus(0):($ionicTip.show("对方已挂断，请点击“挂断”按钮返回 ...").timeout(5e3),isEnder=!0),vid&&$http.get("/api/pay/chatRecord/end/"+vid)}),webrtc.on("localMediaError",function(err){var name=err.name,jid=roomid.replace(m_jid,"").replace("_","");con.send($msg({type:"chat",to:jid+"@facetalk"}).c("body").t(name)),"PermissionDeniedError"==name&&$ionicTip.show('浏览器未能开启摄像头，请按此<a class="link" target="_blank" href="http://tieba.baidu.com/p/3234947658">（链接）</a>说明，开启摄像头 ...').timeout(5e3),$ionicXmpp.setStatus(0)}))},cancelRTC:function(){var webrtc=$ionicXmpp.webrtc;isEnder=!0,webrtc.stopLocalVideo(),webrtc.leaveRoom(),$ionicNavBarDelegate.back()}}});var controllersModule=angular.module("facetalk.Controllers",[]);controllersModule.controller("loginCtrl",function($rootScope,$scope,$ionicUser,$validor,$state,$ionicTip){$ionicTip.hide(),$scope.login=function(form,user){form.$valid?$ionicUser.login(user.loginEmail,user.loginPassword,function(){if($rootScope.isComplete)$state.go("tabs.home");else{var complete=$rootScope.userInfo.infoCompleteness;$state.go(complete?"tabs.removeTip":"tabs.takeTip")}}):$validor.login(form)},$scope.submit=function(event,form,user){var keyCode=event.keyCode||event.which;13==keyCode&&$scope.login(form,user)}}).controller("registCtrl",function($scope,$ionicUser,$state,$validor){$scope.pattern=/^[a-zA-Z\d_\u4e00-\u9fa5]{4,18}$/,$scope.next=function(form,user){form.$valid?$ionicUser.regist(user.name,user.password,user.email,function(){$state.go("tabs.takeTip")}):$validor.regist(form)},$scope.submit=function(event,form,user){var keyCode=event.keyCode||event.which;13==keyCode&&$scope.next(form,user)}}).controller("removeTipCtrl",function($rootScope,$scope){var complete=$rootScope.userInfo.infoCompleteness,msg="";2==complete?msg="头像不清晰":3==complete?msg="头像不完整":4==complete?msg="非本人头像":5==complete&&(msg="头像不雅"),$scope.removeInfo=msg,$scope.takeURL="#/tab/settingTake"}).controller("takeCtrl",function($rootScope,$scope,$state,$ionicVideo,$ionicNavBarDelegate){$ionicVideo.loadVideo(),$scope.taking=function(){$ionicVideo.take.call($ionicVideo)},$scope.choose=function(){$ionicVideo.choose.call($ionicVideo,function(){$ionicVideo.stream&&$ionicVideo.stream.stop(),$state.go("tabs.home")})},$scope.reset=$ionicVideo.reset,$scope.back=function(){$ionicVideo.stream&&$ionicVideo.stream.stop(),$ionicVideo.stream=null,$ionicNavBarDelegate.back()}}).controller("detailCtrl",function($rootScope,$scope,$stateParams,$http,$state,$ionicTip,$ionicXmpp){var from_jid=$rootScope.userInfo.username,jid=$scope.username=$stateParams.jid,from_nick=$rootScope.userInfo.name;return jid==from_jid?($scope.myself=!0,void($scope.status="自己")):($http.get("/xmpp/user/status/"+jid+"@facetalk/xml").success(function(data){/chat/.test(data)?($scope.status="空闲",$scope.canChat=!0):/dnd/.test(data)?$scope.status="通话中":/(?:error|unavailable)/.test(data)&&($scope.status="离线")}),$http.get("/api/user/get/"+jid).success(function(data){$scope.info=data}).error(function(){}),$scope.xin=function(){$state.go("tabs.xin-detail",{jid:jid,name:encodeURI($scope.info.name)})},void($scope.chat=function(){var from={jid:from_jid,nick:from_nick},to={jid:jid,nick:$scope.info.name};$ionicXmpp.sendSignal("video",from,to),$ionicTip.show("正在发送视频请求，请勿刷新页面 ...","false").timeout(3e4,function(){$ionicXmpp.sendSignal("timeout",from,to)})}))}).controller("chatCtrl",function($scope,$stateParams,$ionicPopup,$ionicVideo,$ionicTip,$ionicXmpp,$state){$ionicTip.hide(),$ionicVideo.initRTC($stateParams),$ionicTip.show("正在建立视频连接，请勿刷新页面 ...").timeout(3e4,function(){var f_jid=$stateParams.roomid.split("_")[1],nick=$stateParams.nick;$ionicTip.hide(),$ionicPopup.confirm({title:"超时通知",template:"视频连接超时 ...",okText:"给TA留言",cancelText:"确定"}).then(function(res){if($ionicXmpp.setStatus(0),res){var webrtc=$ionicXmpp.webrtc;webrtc.stopLocalVideo(),webrtc.leaveRoom(),$state.go("tabs.xin-detail",{jid:f_jid,name:nick})}else $scope.close()})}),$scope.close=function(){$ionicXmpp.setStatus(0),$ionicTip.hide(),$ionicVideo.cancelRTC()}}).controller("xinCtrl",function($rootScope,$scope,$ionicStorage){var facexin=$ionicStorage.facexin;facexin||$ionicStorage.init();var notices=$ionicStorage.facexin.notices,xins=$ionicStorage.facexin.xins,unreaded={};$rootScope.badgeCounts=0,angular.forEach(notices,function(notice){var jid=notice.jid;unreaded[jid]=xins[jid].unreaded}),$scope.notices=notices,$scope.unreaded=unreaded,$scope.$on("news",function(event,message){var jid=message.jid;$scope.$apply(function(){unreaded[jid]=xins[jid].unreaded})})}).controller("xinDetailCtrl",function($rootScope,$scope,$http,$stateParams,$ionicStorage,$ionicVideo,$ionicTip,$ionicRecord,$ionicXmpp,$ionicNavBarDelegate,$ionicScrollDelegate,$timeout){var my_jid=$rootScope.userInfo.username,jid=$stateParams.jid,nick=$rootScope.userInfo.name;$ionicVideo.loadVideo(_$("facexin"),"请按照浏览器提示，允许使用摄像头",function(){$ionicTip.hide()});var facexin=$ionicStorage.facexin;facexin||$ionicStorage.init();var xins=$ionicStorage.facexin.xins;xins[jid]=xins[jid]||{},$scope.lists=(xins[jid].lists||[]).slice(0),$scope.name=decodeURI($stateParams.name),xins[jid].unreaded&&($rootScope.badgeCounts&&($rootScope.badgeCounts-=xins[jid].unreaded),xins[jid].unreaded=0,Storage.set("facexin",$ionicStorage.facexin)),$scope.$on("news",function(event,message){message.jid==jid&&($scope.lists.push(message),$rootScope.badgeCounts-=1,xins[jid].unreaded=0,Storage.set("facexin",$ionicStorage.facexin),$timeout(function(){$ionicScrollDelegate.scrollBottom()},500))});var input=angular.element(_$("chatBar")).find("input");input.on("keydown",function(e){var keyCode=e.keyCode||e.which;if(13==keyCode)if(input.val().length>50)$ionicTip.show("最多允许输入50个字符").timeout();else{var v=input.val(),time=1;input.val("消息发送中，请稍后 ..."),input.attr("disabled","disabled"),$ionicRecord.showTimer(_$("facexin").parentNode,time),$ionicRecord.run({video:_$("facexin"),times:time},function(data){var time=(new Date).getTime(),gifId=my_jid+"_"+time,para="picData="+encodeURIComponent(data)+"&gifId="+gifId;$http.post("/api/facesms/saveGif",para).success(function(data){var status=data.status;if("success"==status){$ionicXmpp.connection.send($msg({type:"chat",to:jid+"@facetalk",gifid:gifId,nick:nick}).c("body").t(v));var message={jid:jid,name:$scope.name,url:"/faceSmsGif/"+gifId.substring(0,2)+"/"+gifId.substring(2,4)+"/"+gifId+".gif",text:v};$ionicStorage.set(message,!0),$scope.lists.push(message),$timeout(function(){$ionicScrollDelegate.scrollBottom()},500),input.removeAttr("disabled"),input.val(""),input[0].focus()}})})}}),$scope.back=function(){$ionicVideo.stream.stop(),$ionicVideo.stream=null,$ionicNavBarDelegate.back()}}),LZWEncoder=function(){var imgW,imgH,pixAry,initCodeSize,remaining,curPixel,n_bits,maxcode,g_init_bits,ClearCode,EOFCode,a_count,exports={},EOF=-1,BITS=12,HSIZE=5003,maxbits=BITS,maxmaxcode=1<<BITS,htab=[],codetab=[],hsize=HSIZE,free_ent=0,clear_flg=!1,cur_accum=0,cur_bits=0,masks=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],accum=[],LZWEncoder=exports.LZWEncoder=function(width,height,pixels,color_depth){imgW=width,imgH=height,pixAry=pixels,initCodeSize=Math.max(2,color_depth)
},char_out=function(c,outs){accum[a_count++]=c,a_count>=254&&flush_char(outs)},cl_block=function(outs){cl_hash(hsize),free_ent=ClearCode+2,clear_flg=!0,output(ClearCode,outs)},cl_hash=function(hsize){for(var i=0;hsize>i;++i)htab[i]=-1},compress=exports.compress=function(init_bits,outs){var fcode,i,c,ent,disp,hsize_reg,hshift;for(g_init_bits=init_bits,clear_flg=!1,n_bits=g_init_bits,maxcode=MAXCODE(n_bits),ClearCode=1<<init_bits-1,EOFCode=ClearCode+1,free_ent=ClearCode+2,a_count=0,ent=nextPixel(),hshift=0,fcode=hsize;65536>fcode;fcode*=2)++hshift;hshift=8-hshift,hsize_reg=hsize,cl_hash(hsize_reg),output(ClearCode,outs);outer_loop:for(;(c=nextPixel())!=EOF;)if(fcode=(c<<maxbits)+ent,i=c<<hshift^ent,htab[i]!=fcode){if(htab[i]>=0){disp=hsize_reg-i,0===i&&(disp=1);do if((i-=disp)<0&&(i+=hsize_reg),htab[i]==fcode){ent=codetab[i];continue outer_loop}while(htab[i]>=0)}output(ent,outs),ent=c,maxmaxcode>free_ent?(codetab[i]=free_ent++,htab[i]=fcode):cl_block(outs)}else ent=codetab[i];output(ent,outs),output(EOFCode,outs)},flush_char=(exports.encode=function(os){os.writeByte(initCodeSize),remaining=imgW*imgH,curPixel=0,compress(initCodeSize+1,os),os.writeByte(0)},function(outs){a_count>0&&(outs.writeByte(a_count),outs.writeBytes(accum,0,a_count),a_count=0)}),MAXCODE=function(n_bits){return(1<<n_bits)-1},nextPixel=function(){if(0===remaining)return EOF;--remaining;var pix=pixAry[curPixel++];return 255&pix},output=function(code,outs){for(cur_accum&=masks[cur_bits],cur_bits>0?cur_accum|=code<<cur_bits:cur_accum=code,cur_bits+=n_bits;cur_bits>=8;)char_out(255&cur_accum,outs),cur_accum>>=8,cur_bits-=8;if((free_ent>maxcode||clear_flg)&&(clear_flg?(maxcode=MAXCODE(n_bits=g_init_bits),clear_flg=!1):(++n_bits,maxcode=n_bits==maxbits?maxmaxcode:MAXCODE(n_bits))),code==EOFCode){for(;cur_bits>0;)char_out(255&cur_accum,outs),cur_accum>>=8,cur_bits-=8;flush_char(outs)}};return LZWEncoder.apply(this,arguments),exports},NeuQuant=function(){var alphadec,thepicture,lengthcount,samplefac,network,exports={},netsize=256,prime1=499,prime2=491,prime3=487,prime4=503,minpicturebytes=3*prime4,maxnetpos=netsize-1,netbiasshift=4,ncycles=100,intbiasshift=16,intbias=1<<intbiasshift,gammashift=10,betashift=10,beta=intbias>>betashift,betagamma=intbias<<gammashift-betashift,initrad=netsize>>3,radiusbiasshift=6,radiusbias=1<<radiusbiasshift,initradius=initrad*radiusbias,radiusdec=30,alphabiasshift=10,initalpha=1<<alphabiasshift,radbiasshift=8,radbias=1<<radbiasshift,alpharadbshift=alphabiasshift+radbiasshift,alpharadbias=1<<alpharadbshift,netindex=[],bias=[],freq=[],radpower=[],NeuQuant=exports.NeuQuant=function(thepic,len,sample){var i,p;for(thepicture=thepic,lengthcount=len,samplefac=sample,network=new Array(netsize),i=0;netsize>i;i++)network[i]=new Array(4),p=network[i],p[0]=p[1]=p[2]=(i<<netbiasshift+8)/netsize,freq[i]=intbias/netsize,bias[i]=0},colorMap=function(){for(var map=[],index=new Array(netsize),i=0;netsize>i;i++)index[network[i][3]]=i;for(var k=0,l=0;netsize>l;l++){var j=index[l];map[k++]=network[j][0],map[k++]=network[j][1],map[k++]=network[j][2]}return map},inxbuild=function(){var i,j,smallpos,smallval,p,q,previouscol,startpos;for(previouscol=0,startpos=0,i=0;netsize>i;i++){for(p=network[i],smallpos=i,smallval=p[1],j=i+1;netsize>j;j++)q=network[j],q[1]<smallval&&(smallpos=j,smallval=q[1]);if(q=network[smallpos],i!=smallpos&&(j=q[0],q[0]=p[0],p[0]=j,j=q[1],q[1]=p[1],p[1]=j,j=q[2],q[2]=p[2],p[2]=j,j=q[3],q[3]=p[3],p[3]=j),smallval!=previouscol){for(netindex[previouscol]=startpos+i>>1,j=previouscol+1;smallval>j;j++)netindex[j]=i;previouscol=smallval,startpos=i}}for(netindex[previouscol]=startpos+maxnetpos>>1,j=previouscol+1;256>j;j++)netindex[j]=maxnetpos},learn=function(){var i,j,b,g,r,radius,rad,alpha,step,delta,samplepixels,p,pix,lim;for(minpicturebytes>lengthcount&&(samplefac=1),alphadec=30+(samplefac-1)/3,p=thepicture,pix=0,lim=lengthcount,samplepixels=lengthcount/(3*samplefac),delta=samplepixels/ncycles|0,alpha=initalpha,radius=initradius,rad=radius>>radiusbiasshift,1>=rad&&(rad=0),i=0;rad>i;i++)radpower[i]=alpha*((rad*rad-i*i)*radbias/(rad*rad));for(step=minpicturebytes>lengthcount?3:lengthcount%prime1!==0?3*prime1:lengthcount%prime2!==0?3*prime2:lengthcount%prime3!==0?3*prime3:3*prime4,i=0;samplepixels>i;)if(b=(255&p[pix+0])<<netbiasshift,g=(255&p[pix+1])<<netbiasshift,r=(255&p[pix+2])<<netbiasshift,j=contest(b,g,r),altersingle(alpha,j,b,g,r),0!==rad&&alterneigh(rad,j,b,g,r),pix+=step,pix>=lim&&(pix-=lengthcount),i++,0===delta&&(delta=1),i%delta===0)for(alpha-=alpha/alphadec,radius-=radius/radiusdec,rad=radius>>radiusbiasshift,1>=rad&&(rad=0),j=0;rad>j;j++)radpower[j]=alpha*((rad*rad-j*j)*radbias/(rad*rad))},unbiasnet=(exports.map=function(b,g,r){var i,j,dist,a,bestd,p,best;for(bestd=1e3,best=-1,i=netindex[g],j=i-1;netsize>i||j>=0;)netsize>i&&(p=network[i],dist=p[1]-g,dist>=bestd?i=netsize:(i++,0>dist&&(dist=-dist),a=p[0]-b,0>a&&(a=-a),dist+=a,bestd>dist&&(a=p[2]-r,0>a&&(a=-a),dist+=a,bestd>dist&&(bestd=dist,best=p[3])))),j>=0&&(p=network[j],dist=g-p[1],dist>=bestd?j=-1:(j--,0>dist&&(dist=-dist),a=p[0]-b,0>a&&(a=-a),dist+=a,bestd>dist&&(a=p[2]-r,0>a&&(a=-a),dist+=a,bestd>dist&&(bestd=dist,best=p[3]))));return best},exports.process=function(){return learn(),unbiasnet(),inxbuild(),colorMap()},function(){var i;for(i=0;netsize>i;i++)network[i][0]>>=netbiasshift,network[i][1]>>=netbiasshift,network[i][2]>>=netbiasshift,network[i][3]=i}),alterneigh=function(rad,i,b,g,r){var j,k,lo,hi,a,m,p;for(lo=i-rad,-1>lo&&(lo=-1),hi=i+rad,hi>netsize&&(hi=netsize),j=i+1,k=i-1,m=1;hi>j||k>lo;){if(a=radpower[m++],hi>j){p=network[j++];try{p[0]-=a*(p[0]-b)/alpharadbias,p[1]-=a*(p[1]-g)/alpharadbias,p[2]-=a*(p[2]-r)/alpharadbias}catch(e){}}if(k>lo){p=network[k--];try{p[0]-=a*(p[0]-b)/alpharadbias,p[1]-=a*(p[1]-g)/alpharadbias,p[2]-=a*(p[2]-r)/alpharadbias}catch(e){}}}},altersingle=function(alpha,i,b,g,r){var n=network[i];n[0]-=alpha*(n[0]-b)/initalpha,n[1]-=alpha*(n[1]-g)/initalpha,n[2]-=alpha*(n[2]-r)/initalpha},contest=function(b,g,r){var i,dist,a,biasdist,betafreq,bestpos,bestbiaspos,bestd,bestbiasd,n;for(bestd=~(1<<31),bestbiasd=bestd,bestpos=-1,bestbiaspos=bestpos,i=0;netsize>i;i++)n=network[i],dist=n[0]-b,0>dist&&(dist=-dist),a=n[1]-g,0>a&&(a=-a),dist+=a,a=n[2]-r,0>a&&(a=-a),dist+=a,bestd>dist&&(bestd=dist,bestpos=i),biasdist=dist-(bias[i]>>intbiasshift-netbiasshift),bestbiasd>biasdist&&(bestbiasd=biasdist,bestbiaspos=i),betafreq=freq[i]>>betashift,freq[i]-=betafreq,bias[i]+=betafreq<<gammashift;return freq[bestpos]+=beta,bias[bestpos]-=betagamma,bestbiaspos};return NeuQuant.apply(this,arguments),exports},GIFEncoder=function(){function ByteArray(){this.bin=[]}for(var i=0,chr={};256>i;i++)chr[i]=String.fromCharCode(i);ByteArray.prototype.getData=function(){for(var v="",l=this.bin.length,i=0;l>i;i++)v+=chr[this.bin[i]];return v},ByteArray.prototype.writeByte=function(val){this.bin.push(val)},ByteArray.prototype.writeUTFBytes=function(string){for(var l=string.length,i=0;l>i;i++)this.writeByte(string.charCodeAt(i))},ByteArray.prototype.writeBytes=function(array,offset,length){for(var l=length||array.length,i=offset||0;l>i;i++)this.writeByte(array[i])};var width,height,transIndex,out,image,pixels,indexedPixels,colorDepth,colorTab,exports={},transparent=null,repeat=-1,delay=0,started=!1,usedEntry=[],palSize=7,dispose=-1,closeStream=!1,firstFrame=!0,sizeSet=!1,sample=10,comment="Generated by jsgif (https://github.com/antimatter15/jsgif/)",reset=(exports.setDelay=function(ms){delay=Math.round(ms/10)},exports.setDispose=function(code){code>=0&&(dispose=code)},exports.setRepeat=function(iter){iter>=0&&(repeat=iter)},exports.setTransparent=function(c){transparent=c},exports.setComment=function(c){comment=c},exports.addFrame=function(im,is_imageData){if(null===im||!started||null===out)throw new Error("Please call start method before calling addFrame");var ok=!0;try{is_imageData?image=im:(image=im.getImageData(0,0,im.canvas.width,im.canvas.height).data,sizeSet||setSize(im.canvas.width,im.canvas.height)),getImagePixels(),analyzePixels(),firstFrame&&(writeLSD(),writePalette(),repeat>=0&&writeNetscapeExt()),writeGraphicCtrlExt(),""!==comment&&writeCommentExt(),writeImageDesc(),firstFrame||writePalette(),writePixels(),firstFrame=!1}catch(e){ok=!1}return ok},exports.finish=function(){if(!started)return!1;var ok=!0;started=!1;try{out.writeByte(59)}catch(e){ok=!1}return ok},function(){transIndex=0,image=null,pixels=null,indexedPixels=null,colorTab=null,closeStream=!1,firstFrame=!0}),setSize=(exports.setFrameRate=function(fps){15!=fps&&(delay=Math.round(100/fps))},exports.setQuality=function(quality){1>quality&&(quality=1),sample=quality},exports.setSize=function(w,h){(!started||firstFrame)&&(width=w,height=h,1>width&&(width=320),1>height&&(height=240),sizeSet=!0)}),analyzePixels=(exports.start=function(){reset();var ok=!0;closeStream=!1,out=new ByteArray;try{out.writeUTFBytes("GIF89a")}catch(e){ok=!1}return started=ok},exports.cont=function(){reset();var ok=!0;return closeStream=!1,out=new ByteArray,started=ok},function(){var len=pixels.length,nPix=len/3;indexedPixels=[];var nq=new NeuQuant(pixels,len,sample);colorTab=nq.process();for(var k=0,j=0;nPix>j;j++){var index=nq.map(255&pixels[k++],255&pixels[k++],255&pixels[k++]);usedEntry[index]=!0,indexedPixels[j]=index}pixels=null,colorDepth=8,palSize=7,null!==transparent&&(transIndex=findClosest(transparent))}),findClosest=function(c){if(null===colorTab)return-1;for(var r=(16711680&c)>>16,g=(65280&c)>>8,b=255&c,minpos=0,dmin=16777216,len=colorTab.length,i=0;len>i;){var dr=r-(255&colorTab[i++]),dg=g-(255&colorTab[i++]),db=b-(255&colorTab[i]),d=dr*dr+dg*dg+db*db,index=i/3;usedEntry[index]&&dmin>d&&(dmin=d,minpos=index),i++}return minpos},getImagePixels=function(){var w=width,h=height;pixels=[];for(var data=image,count=0,i=0;h>i;i++)for(var j=0;w>j;j++){var b=i*w*4+4*j;pixels[count++]=data[b],pixels[count++]=data[b+1],pixels[count++]=data[b+2]}},writeGraphicCtrlExt=function(){out.writeByte(33),out.writeByte(249),out.writeByte(4);var transp,disp;null===transparent?(transp=0,disp=0):(transp=1,disp=2),dispose>=0&&(disp=7&dispose),disp<<=2,out.writeByte(0|disp|0|transp),WriteShort(delay),out.writeByte(transIndex),out.writeByte(0)},writeCommentExt=function(){out.writeByte(33),out.writeByte(254),out.writeByte(comment.length),out.writeUTFBytes(comment),out.writeByte(0)},writeImageDesc=function(){out.writeByte(44),WriteShort(0),WriteShort(0),WriteShort(width),WriteShort(height),out.writeByte(firstFrame?0:128|palSize)},writeLSD=function(){WriteShort(width),WriteShort(height),out.writeByte(240|palSize),out.writeByte(0),out.writeByte(0)},writeNetscapeExt=function(){out.writeByte(33),out.writeByte(255),out.writeByte(11),out.writeUTFBytes("NETSCAPE2.0"),out.writeByte(3),out.writeByte(1),WriteShort(repeat),out.writeByte(0)},writePalette=function(){out.writeBytes(colorTab);for(var n=768-colorTab.length,i=0;n>i;i++)out.writeByte(0)},WriteShort=function(pValue){out.writeByte(255&pValue),out.writeByte(pValue>>8&255)},writePixels=function(){var myencoder=new LZWEncoder(width,height,indexedPixels,colorDepth);myencoder.encode(out)};return exports.stream=function(){return out},exports.setProperties=function(has_start,is_first){started=has_start,firstFrame=is_first},exports};